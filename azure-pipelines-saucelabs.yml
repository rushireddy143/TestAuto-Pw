trigger:
  branches:
    include:
    - main
    - develop
    - test

pr:
  branches:
    include:
    - main
    - develop

schedules:
- cron: "30 15 * * *"
  displayName: Nightly Sauce Labs Tests
  branches:
    include:
    - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'

jobs:
- job: SauceLabsTests
  displayName: 'Sauce Labs Playwright Tests'
  timeoutInMinutes: 60
  
  strategy:
    matrix:
      ChromeWindows:
        browserProject: 'saucelabs-chrome-windows'
        displayName: 'Chrome on Windows 11'
      FirefoxWindows:
        browserProject: 'saucelabs-firefox-windows'
        displayName: 'Firefox on Windows 11'
      SafariMac:
        browserProject: 'saucelabs-webkit-mac'
        displayName: 'Safari on macOS 13'
      EdgeWindows:
        browserProject: 'saucelabs-edge-windows'
        displayName: 'Edge on Windows 11'
      ChromeAndroid:
        browserProject: 'saucelabs-mobile-chrome'
        displayName: 'Chrome on Android'
      SafariiOS:
        browserProject: 'saucelabs-mobile-safari'
        displayName: 'Safari on iOS'
    maxParallel: 6
  
  steps:
  - task: NodeTool@0
    displayName: 'Install Node.js $(NODE_VERSION)'
    inputs:
      versionSpec: '$(NODE_VERSION)'
  
  - task: Cache@2
    displayName: 'Cache npm dependencies'
    inputs:
      key: 'npm | "$(Agent.OS)" | package-lock.json'
      restoreKeys: |
        npm | "$(Agent.OS)"
      path: '$(Pipeline.Workspace)/.npm'
  
  - script: |
      npm ci
    displayName: 'Install dependencies'
  
  - script: |
      npx playwright test --config=playwright.saucelabs.config.ts --project=$(browserProject)
    displayName: 'Run tests on Sauce Labs - $(displayName)'
    env:
      SAUCE_USERNAME: $(SAUCE_USERNAME)
      SAUCE_ACCESS_KEY: $(SAUCE_ACCESS_KEY)
      CI: 'true'
    continueOnError: true
  
  - task: PublishTestResults@2
    displayName: 'Publish Test Results - $(displayName)'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/test-results.xml'
      testRunTitle: 'Sauce Labs - $(displayName)'
      mergeTestResults: false
    condition: always()
  
  - task: PublishPipelineArtifact@1
    displayName: 'Publish Test Artifacts - $(displayName)'
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)/test-results'
      artifact: 'saucelabs-results-$(browserProject)'
      publishLocation: 'pipeline'
    condition: always()
  
  - task: PublishPipelineArtifact@1
    displayName: 'Publish HTML Report - $(displayName)'
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)/playwright-report'
      artifact: 'saucelabs-report-$(browserProject)'
      publishLocation: 'pipeline'
    condition: always()

- job: NotifySauceLabs
  displayName: 'Notify Teams - Sauce Labs Results'
  dependsOn: SauceLabsTests
  condition: always()
  
  steps:
  - task: PowerShell@2
    displayName: 'Send Sauce Labs Results to Teams'
    inputs:
      targetType: 'inline'
      script: |
        $teamsWebhook = "$(TEAMS_WEBHOOK_URL)"
        
        if ([string]::IsNullOrEmpty($teamsWebhook)) {
            Write-Host "Teams webhook URL not configured. Skipping notification."
            exit 0
        }
        
        $status = "$(Agent.JobStatus)"
        $color = if ($status -eq "Succeeded") { "00FF00" } else { "FF0000" }
        $emoji = if ($status -eq "Succeeded") { "‚úÖ" } else { "‚ùå" }
        $title = "$emoji Sauce Labs Playwright Tests - $status"
        
        $body = @{
            "@type" = "MessageCard"
            "@context" = "https://schema.org/extensions"
            "summary" = "Sauce Labs Test Results"
            "themeColor" = $color
            "title" = $title
            "sections" = @(
                @{
                    "activityTitle" = "üåê Cross-Browser & Cross-Platform Testing"
                    "activitySubtitle" = "Executed on Sauce Labs Cloud"
                    "facts" = @(
                        @{
                            "name" = "Repository"
                            "value" = "$(Build.Repository.Name)"
                        },
                        @{
                            "name" = "Branch"
                            "value" = "$(Build.SourceBranchName)"
                        },
                        @{
                            "name" = "Platforms"
                            "value" = "Windows 11, macOS 13, Android, iOS"
                        },
                        @{
                            "name" = "Browsers"
                            "value" = "Chrome, Firefox, Safari, Edge"
                        },
                        @{
                            "name" = "Build Number"
                            "value" = "$(Build.BuildNumber)"
                        },
                        @{
                            "name" = "Triggered By"
                            "value" = "$(Build.RequestedFor)"
                        }
                    )
                }
            )
            "potentialAction" = @(
                @{
                    "@type" = "OpenUri"
                    "name" = "View Pipeline"
                    "targets" = @(
                        @{
                            "os" = "default"
                            "uri" = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
                        }
                    )
                },
                @{
                    "@type" = "OpenUri"
                    "name" = "Sauce Labs Dashboard"
                    "targets" = @(
                        @{
                            "os" = "default"
                            "uri" = "https://app.saucelabs.com/dashboard/tests"
                        }
                    )
                }
            )
        } | ConvertTo-Json -Depth 10
        
        Invoke-RestMethod -Method Post -Uri $teamsWebhook -Body $body -ContentType "application/json"
    continueOnError: true