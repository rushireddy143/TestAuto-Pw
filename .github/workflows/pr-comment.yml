name: PR Comment with Test Results

on:
  workflow_run:
    workflows: ["Playwright Tests"]
    types:
      - completed

permissions:
  pull-requests: write
  issues: write
  actions: read

jobs:
  comment:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          
      - name: Read test results
        id: test-results
        run: |
          if [ -f test-results.json ]; then
            echo "results<<EOF" >> $GITHUB_OUTPUT
            cat test-results.json >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: '${{ github.event.workflow_run.head_sha }}'
            });
            
            if (pullRequests.length === 0) {
              console.log('No pull requests found for this commit');
              return;
            }
            
            const pr = pullRequests[0];
            const conclusion = '${{ github.event.workflow_run.conclusion }}';
            const runUrl = '${{ github.event.workflow_run.html_url }}';
            
            let emoji = conclusion === 'success' ? '‚úÖ' : '‚ùå';
            let status = conclusion === 'success' ? 'passed' : 'failed';
            
            const comment = `## ${emoji} Playwright Test Results
            
            **Status:** ${status}
            **Workflow:** [View Results](${runUrl})
            
            ### Test Summary
            - **Browsers Tested:** Chromium, Firefox, WebKit
            - **Node Versions:** 18, 20
            - **Commit:** \`${{ github.event.workflow_run.head_sha }}\`
            
            ${conclusion === 'success' ? 
              'üéâ All tests passed successfully!' : 
              '‚ö†Ô∏è Some tests failed. Please check the workflow logs for details.'}
            
            ---
            *Automated comment by GitHub Actions*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });